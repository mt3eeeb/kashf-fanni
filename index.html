<!-- ===== Ø¨Ù†Ø¯ 4 : Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø£Ø±Ø¶ ===== -->
<div class="section">
  <div class="section-title">4ï¸âƒ£ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø£Ø±Ø¶</div>
  <div class="section-body">

    <div id="pointsContainer"></div>

    <button type="button" onclick="addPoint()">â• Ø¥Ø¶Ø§ÙØ© Ø²Ø§ÙˆÙŠØ©</button>
    <button type="button" onclick="calculateArea()">ğŸ“ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø­Ø©</button>

    <div id="areaResult" style="margin-top:12px;font-weight:bold;"></div>

  </div>
</div>

<style>
.point-row{
  display:flex;
  gap:10px;
  align-items:flex-end;
  margin-bottom:8px;
}
.point-row .num{
  width:40px;
  text-align:center;
  font-weight:bold;
}
.point-row input{
  flex:1;
  padding:6px;
}
.point-row button{
  padding:6px 10px;
}
</style>

<script>
let pointCount = 0;

// Ø¥Ø¶Ø§ÙØ© Ø²Ø§ÙˆÙŠØ©
function addPoint(lat='', lon=''){
  pointCount++;
  document.getElementById('pointsContainer').insertAdjacentHTML('beforeend',`
    <div class="point-row">
      <div class="num">${pointCount}</div>
      <input type="number" step="any" placeholder="Latitude" value="${lat}">
      <input type="number" step="any" placeholder="Longitude" value="${lon}">
      <button type="button" onclick="removePoint(this)">â–</button>
    </div>
  `);
}

// Ø­Ø°Ù Ø²Ø§ÙˆÙŠØ©
function removePoint(btn){
  btn.parentElement.remove();
  renumberPoints();
}

// Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±Ù‚ÙŠÙ…
function renumberPoints(){
  pointCount = 0;
  document.querySelectorAll('.point-row .num').forEach(n=>{
    n.textContent = ++pointCount;
  });
}

// ===== ØªØ­ÙˆÙŠÙ„ WGS84 Ø¥Ù„Ù‰ UTM =====
function latLonToUTM(lat, lon){
  const a = 6378137;
  const f = 1/298.257223563;
  const k0 = 0.9996;
  const e = Math.sqrt(f*(2-f));
  const zone = Math.floor((lon + 180)/6) + 1;
  const Î»0 = ((zone - 1)*6 - 180 + 3) * Math.PI/180;

  lat *= Math.PI/180;
  lon *= Math.PI/180;

  const N = a / Math.sqrt(1 - e*e*Math.sin(lat)**2);
  const T = Math.tan(lat)**2;
  const C = (e*e/(1-e*e)) * Math.cos(lat)**2;
  const A = Math.cos(lat)*(lon - Î»0);

  const M = a*((1 - e*e/4 - 3*e**4/64 - 5*e**6/256)*lat
    - (3*e*e/8 + 3*e**4/32 + 45*e**6/1024)*Math.sin(2*lat)
    + (15*e**4/256 + 45*e**6/1024)*Math.sin(4*lat)
    - (35*e**6/3072)*Math.sin(6*lat));

  const x = k0*N*(A + (1-T+C)*A**3/6 + (5-18*T+T*T+72*C)*A**5/120);
  const y = k0*(M + N*Math.tan(lat)*(A*A/2 + (5-T+9*C)*A**4/24));

  return {x, y};
}

// ===== Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø­Ø© =====
function calculateArea(){
  const rows = document.querySelectorAll('.point-row');
  if(rows.length < 3){
    alert('Ø£Ø¯Ø®Ù„ 3 Ø²ÙˆØ§ÙŠØ§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
    return;
  }

  let pts = [];
  rows.forEach(r=>{
    const lat = parseFloat(r.children[1].value);
    const lon = parseFloat(r.children[2].value);
    if(!isNaN(lat) && !isNaN(lon)){
      pts.push(latLonToUTM(lat, lon));
    }
  });

  let area = 0;
  for(let i=0;i<pts.length;i++){
    let j = (i+1)%pts.length;
    area += pts[i].x*pts[j].y - pts[j].x*pts[i].y;
  }
  area = Math.abs(area/2);

  document.getElementById('areaResult').innerHTML = `
    Ø§Ù„Ù…Ø³Ø§Ø­Ø©:<br>
    ${area.toFixed(2)} Ù…Â²<br>
    ${(area/1000).toFixed(2)} Ø¯ÙˆÙ†Ù…<br>
    ${(area/10000).toFixed(2)} Ù‡ÙƒØªØ§Ø±
  `;
}

// Ø¨Ø¯Ø§ÙŠØ© Ø¨Ø¯ÙˆÙ† Ø®Ø§Ù†Ø§Øª
</script>
