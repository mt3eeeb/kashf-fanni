<!-- Ø¨Ù†Ø¯ 4: Ø²ÙˆØ§ÙŠØ§ Ø§Ù„Ù…Ø²Ø±Ø¹Ø© -->
<div class="section">
  <h3>Ø²ÙˆØ§ÙŠØ§ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©</h3>

  <div id="corners"></div>

  <div style="margin-top:8px; display:flex; gap:10px;">
    <button type="button" onclick="addCorner()">â• Ø¥Ø¶Ø§ÙØ© Ø²Ø§ÙˆÙŠØ©</button>
    <button type="button" onclick="calculatePolygon()">ğŸ“ Ø§Ø­Ø³Ø¨ Ø§Ù„Ø£Ø·ÙˆØ§Ù„ ÙˆØ§Ù„Ù…Ø³Ø§Ø­Ø©</button>
  </div>

  <div class="result" id="cornerResult" style="margin-top:10px;"></div>
</div>

<script>
function addCorner(){
  const div = document.createElement('div');
  div.className = 'row';
  div.innerHTML = `
    <div class="field">
      <label>Latitude</label>
      <input type="text" class="lat">
    </div>
    <div class="field">
      <label>Longitude</label>
      <input type="text" class="lng">
    </div>
    <button type="button" onclick="this.parentElement.remove()">â–</button>
  `;
  document.getElementById('corners').appendChild(div);
}

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ù†Ù‚Ø·ØªÙŠÙ† (Haversine)
function distance(lat1, lon1, lat2, lon2){
  const R = 6371000;
  const toRad = d => d * Math.PI / 180;

  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);

  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
    Math.sin(dLon/2)**2;

  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function calculatePolygon(){
  const rows = document.querySelectorAll('#corners .row');
  if(rows.length < 3){
    alert('Ø£Ø¯Ø®Ù„ 3 Ø²ÙˆØ§ÙŠØ§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
    return;
  }

  let points = [];
  rows.forEach(r=>{
    const lat = parseFloat(r.querySelector('.lat').value);
    const lng = parseFloat(r.querySelector('.lng').value);
    if(!isNaN(lat) && !isNaN(lng)){
      points.push([lat, lng]);
    }
  });

  if(points.length < 3){
    alert('ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª');
    return;
  }

  // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø·ÙˆØ§Ù„
  let txt = '<b>Ø§Ù„Ø£Ø·ÙˆØ§Ù„:</b><br>';
  let area = 0;

  for(let i=0;i<points.length;i++){
    const j = (i+1) % points.length;

    const d = distance(
      points[i][0], points[i][1],
      points[j][0], points[j][1]
    );

    txt += `Ù…Ù† ${i+1} Ø¥Ù„Ù‰ ${j+1}: ${d.toFixed(2)} Ù…<br>`;

    area +=
      points[i][1]*points[j][0] -
      points[j][1]*points[i][0];
  }

  // Ø§Ù„Ù…Ø³Ø§Ø­Ø© (ØªØ­ÙˆÙŠÙ„ ØªÙ‚Ø±ÙŠØ¨ÙŠ ØµØ­ÙŠØ­ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠ)
  area = Math.abs(area/2) * 111000 * 111000;

  txt += `<hr>
    <b>Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</b><br>
    ${area.toFixed(2)} Ù…Â²<br>
    ${(area/10000).toFixed(3)} Ù‡ÙƒØªØ§Ø±<br>
    ${(area/1000).toFixed(2)} Ø¯ÙˆÙ†Ù…
  `;

  document.getElementById('cornerResult').innerHTML = txt;
}
</script>