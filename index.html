<script>
/* ===== بند 6: نظام الري ===== */

let irrigation = [];

// تحميل
window.addEventListener("load", () => {
  const saved = localStorage.getItem("irrigation");
  irrigation = saved ? JSON.parse(saved) : [];
  renderIrrigation();
});

// حفظ
function saveIrrigation() {
  localStorage.setItem("irrigation", JSON.stringify(irrigation));
}

// إضافة
function addIrrigation() {
  irrigation.push({
  type: "",
  towers: ""
  });
  saveIrrigation();
  renderIrrigation();
}

// حذف
function removeIrrigation(i) {
  irrigation.splice(i, 1);
  saveIrrigation();
  renderIrrigation();
}

// تحديث
function updateIrrigation(i, field, value) {
  irrigation[i][field] = value;
  saveIrrigation();
  renderIrrigation();
}

// حساب المساحة
function calcArea(towers) {
  const t = Number(towers);
  if (!t) return { m: 0, h: 0, d: 0 };

  const area = t * 50 * 50; // متر مربع
  return {
    m: area,
    h: (area / 10000).toFixed(3),
    d: (area / 1000).toFixed(2)
  };
}

// عرض
function renderIrrigation() {
  const c = document.getElementById("irrigationContainer");
  c.innerHTML = "";

  irrigation.forEach((r, i) => {
    const a = calcArea(r.towers);

    c.innerHTML += `
      <div style="margin-bottom:8px">
        نوع الري:
        <select onchange="updateIrrigation(${i},'type',this.value)">
          <option value="">—</option>
          <option ${r.type==="رشاش"?"selected":""}>رشاش</option>
          <option ${r.type==="تنقيط"?"selected":""}>تنقيط</option>
          <option ${r.type==="غمر"?"selected":""}>غمر</option>
        </select>

        عدد الأبراج:
        <input type="number" value="${r.towers}"
          oninput="updateIrrigation(${i},'towers',this.value)">

        <button onclick="removeIrrigation(${i})">−</button>

        <div style="font-size:13px;margin-top:4px">
          المساحة:
          ${a.m} م² |
          ${a.h} هكتار |
          ${a.d} دونم
        </div>
      </div>
    `;
  });
}
</script>