<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ù†Ø¸Ø§Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©</title>
<style>
body{
  font-family: Arial;
  direction: rtl;
  background:#f5f5f5;
  padding:20px;
}
h2{
  background:#2ecc71;
  color:#fff;
  padding:10px;
}
.box{
  background:#fff;
  padding:10px;
  margin-bottom:10px;
  border-radius:6px;
}
input{
  width:100%;
  padding:6px;
  margin-bottom:6px;
}
button{
  padding:6px 10px;
  margin:3px;
}
.result{
  background:#fff;
  padding:10px;
  border-radius:6px;
  font-size:16px;
}
</style>
</head>

<body>

<h2>Ø²ÙˆØ§ÙŠØ§ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©</h2>
<div id="corners"></div>
<button onclick="addCorner()">+ Ø¥Ø¶Ø§ÙØ© Ø²Ø§ÙˆÙŠØ©</button>
<button onclick="calcCorners()">Ø­Ø³Ø§Ø¨</button>

<div id="cornerResult" class="result"></div>

<hr>

<h2>Ø§Ù„Ø¢Ø¨Ø§Ø±</h2>
<div id="wells"></div>
<button onclick="addWell()">+ Ø¥Ø¶Ø§ÙØ© Ø¨Ø¦Ø±</button>

<script>
/* =====================
   Ø§Ù„Ø²ÙˆØ§ÙŠØ§
===================== */
let corners = JSON.parse(localStorage.getItem("corners") || "[]");

function addCorner(){
  corners.push({lat:"",lng:""});
  saveCorners();
  renderCorners();
}

function saveCorners(){
  localStorage.setItem("corners",JSON.stringify(corners));
}

function renderCorners(){
  const c = document.getElementById("corners");
  c.innerHTML = "";
  corners.forEach((p,i)=>{
    c.innerHTML += `
    <div class="box">
      <label>Latitude</label>
      <input value="${p.lat}"
        oninput="corners[${i}].lat=this.value;saveCorners()">
      <label>Longitude</label>
      <input value="${p.lng}"
        oninput="corners[${i}].lng=this.value;saveCorners()">
      <button onclick="getCornerLocation(${i})">ğŸ“ ØªØ­Ø¯ÙŠØ¯</button>
    </div>`;
  });
}

function getCornerLocation(i){
  navigator.geolocation.getCurrentPosition(p=>{
    corners[i].lat = p.coords.latitude.toFixed(6);
    corners[i].lng = p.coords.longitude.toFixed(6);
    saveCorners();
    renderCorners();
  });
}

/* =====================
   Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø­Ø© (UTM)
===================== */
function deg2rad(d){ return d*Math.PI/180; }

function toUTM(lat,lng){
  const a=6378137;
  const f=1/298.257223563;
  const k0=0.9996;
  const e=Math.sqrt(f*(2-f));

  const zone=Math.floor((lng+180)/6)+1;
  const Î»0=deg2rad((zone-1)*6-180+3);

  const Ï†=deg2rad(lat);
  const Î»=deg2rad(lng);

  const N=a/Math.sqrt(1-e*e*Math.sin(Ï†)**2);
  const T=Math.tan(Ï†)**2;
  const C=(e*e/(1-e*e))*Math.cos(Ï†)**2;
  const A=Math.cos(Ï†)*(Î»-Î»0);

  const M=a*((1-e*e/4-3*e**4/64)*Ï†
    -(3*e*e/8+3*e**4/32)*Math.sin(2*Ï†));

  const x=k0*N*(A+(1-T+C)*A**3/6)+500000;
  const y=k0*(M+N*Math.tan(Ï†)*A*A/2);

  return {x,y};
}

function calcCorners(){
  if(corners.length<3){
    alert("Ø£Ø¯Ø®Ù„ 3 Ø²ÙˆØ§ÙŠØ§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");
    return;
  }

  let pts=corners.map(p=>toUTM(+p.lat,+p.lng));
  let area=0;
  let txt="";

  for(let i=0;i<pts.length;i++){
    let j=(i+1)%pts.length;
    let dx=pts[j].x-pts[i].x;
    let dy=pts[j].y-pts[i].y;
    let d=Math.sqrt(dx*dx+dy*dy);
    txt+=`Ø¶Ù„Ø¹ ${i+1}-${j+1}: ${d.toFixed(1)} Ù…<br>`;
    area+=pts[i].x*pts[j].y-pts[j].x*pts[i].y;
  }

  area=Math.abs(area/2);

  document.getElementById("cornerResult").innerHTML=
    txt+
    `<br><b>Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</b><br>
    ${area.toFixed(0)} Ù…Â² |
    ${(area/10000).toFixed(2)} Ù‡ÙƒØªØ§Ø± |
    ${(area/1000).toFixed(2)} Ø¯ÙˆÙ†Ù…`;
}

/* =====================
   Ø§Ù„Ø¢Ø¨Ø§Ø±
===================== */
let wells = JSON.parse(localStorage.getItem("wells") || "[]");

function addWell(){
  wells.push({lat:"",lng:""});
  saveWells();
  renderWells();
}

function saveWells(){
  localStorage.setItem("wells",JSON.stringify(wells));
}

function renderWells(){
  const c=document.getElementById("wells");
  c.innerHTML="";
  wells.forEach((w,i)=>{
    c.innerHTML+=`
    <div class="box">
      <label>Latitude</label>
      <input value="${w.lat}"
        oninput="wells[${i}].lat=this.value;saveWells()">
      <label>Longitude</label>
      <input value="${w.lng}"
        oninput="wells[${i}].lng=this.value;saveWells()">
      <button onclick="getWellLocation(${i})">ğŸ“ ØªØ­Ø¯ÙŠØ¯</button>
      <button onclick="openMap(${i})">ğŸ—ºï¸ Ø®Ø±ÙŠØ·Ø©</button>
    </div>`;
  });
}

function getWellLocation(i){
  navigator.geolocation.getCurrentPosition(p=>{
    wells[i].lat=p.coords.latitude.toFixed(6);
    wells[i].lng=p.coords.longitude.toFixed(6);
    saveWells();
    renderWells();
  });
}

function openMap(i){
  if(!wells[i].lat||!wells[i].lng){
    alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª");
    return;
  }
  window.open(`https://www.google.com/maps?q=${wells[i].lat},${wells[i].lng}`);
}

/* ØªØ´ØºÙŠÙ„ */
renderCorners();
renderWells();
</script>

</body>
</html>